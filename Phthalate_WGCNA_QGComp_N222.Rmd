---
title: "QGComp for GAPPS WGCNA Modules and Phthalates"
author: "Samantha Lapehn"
date: "2025-05-01"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## QGComp for GAPPs WGCNA Modules (N=222) and Phthalates
Using this code to run quantile g-based computation for phthalates mixtures in GAPPS and the placental transcriptome (as WGCNA modules) using code shared by Dennis Khodsevich from UC-Berkeley. https://github.com/D-Khodasevich/EWAS_QGComp

### Load Packages and Functions
```{r packages}
library(tidyverse)
library(qgcomp)
library(data.table)
library(edgeR)

source("/Volumes/paquette_a/slapehn/OPE_and_PlacentalTranscriptome/EWAS_QGComp Code from Dennis/EWAS_QGComp_Functions_Update3.R")
#Updated source code received 8/21/23 and should fix the output when using the "full" option for the main and bootstrap functions
```

### Load Data
Need covariates and exposure data
Note: DEHP not included in mixtures since it is not a metabolite that is direclty measured, but rather a molar sum of several metabolites.
```{r load data}
load(file="/Volumes/paquette_a/GAPPSGrant_PrelimData/Resubmission_July2024/output/wgcna/GAPPS_wide_WGCNA_ensembl.RData")
load(file="/Volumes/paquette_a/GAPPSGrant_PrelimData/Sam/Data/FinalCovariates_N222_041525.Rdata")
PHT<-read.csv("/Volumes/paquette_a/GAPPSGrant_PrelimData/Sam/Data/Phthalate_CleanedLogData_GeoMean_LN_N222_041525.csv")

summary(covar_final)
covar_final$batch <- factor(covar_final$batch, levels=c("1", "2", "3"))
summary(covar_final)
```

### Prepare Exposure Data

```{r prep exposure data}
Xnm<-colnames(PHT)
Xnm <- Xnm[2:16]
```

### Prepare Covariate Data
Need to remove any covariates that we aren't using
```{r covar prep}

Covariates_Selected <- covar_final %>%
  dplyr::select( pathways_id, h_c_sex, labor_collapsed, h_del_method, h_m_delivery_age, h_m_prepreg_bmi, h_m_ethn, race_collapsed, edu_collapsed, parity_20, SG, batch)

covars <- c("h_c_sex", "labor_collapsed", "h_del_method", "h_m_delivery_age", "h_m_prepreg_bmi", "h_m_ethn", "race_collapsed", "edu_collapsed", "parity_20", "SG", "batch")

```

### Combine Covariate and Exposure Data into Single dataframe for OPEs
```{r combine exposure and covar for OPE}
Pheno <- data.frame(inner_join(Covariates_Selected, PHT, by=c("pathways_id"="X")))

rownames(Pheno) <- Pheno$pathways_id
Pheno <- Pheno %>%
  dplyr::select(-pathways_id)

#Check data types
summary(Pheno)

```

### Prep Expression Data
```{r expr prep}
#select only MEs for participants with exposure data
MEs_withPHT <- MEs %>%
  dplyr::filter(row.names(MEs) %in% PHT$X)
Pheno_order <-rownames(Pheno)
MEs_reorder <- MEs_withPHT[order(match(rownames(MEs_withPHT), Pheno_order)), , drop = FALSE]
MEs_transpose <- t(MEs_reorder)
meth <- MEs_transpose
```

### Check that order of Expression and Pheno Data are the same
```{r check order}
check <- colnames(meth) == rownames(Pheno)
sum(check)
```

## Bootstrap EWAS QGComp
will perform bootstrapping 

### Run Bootstrap EWAS QGComp
Two new parametes need to be set for bootstrap version: 

Bval is the number of bootstraps to perform
seedval is to set a seed for reproducibility

```{r bootstrap OPE}
ewas_qgcomp_fit.boot <- ewas_qgcomp.boot(pheno = Pheno, meth = meth, 
                           mix_comp = Xnm, covars = covars, mval_conversion=FALSE, 
            qval=4, output_type="full", Bval=1000, seedval=1234)

#save(ewas_qgcomp_fit.boot, file="/Volumes/paquette_a/GAPPSGrant_PrelimData/Sam/Data/GAPPS_Phthalate_WGCNA_QGCompResults_071025.Rdata")
```

### Pull Sig Results
Using p<0.05 for WGCNA
```{r}
WGCNA_qgcomp_results <- ewas_qgcomp_fit.boot$results
print(WGCNA_qgcomp_results)

#write.csv(WGCNA_qgcomp_results,"/Volumes/paquette_a/GAPPSGrant_PrelimData/Sam/Data/GAPPS_Phthalate_WGCNA_QGComp_AllResults_071025.csv")

sig_wgcna_qgcomp <- WGCNA_qgcomp_results %>%
  dplyr::filter(pval<0.05)
#write.csv(sig_wgcna_qgcomp,"/Volumes/paquette_a/GAPPSGrant_PrelimData/Sam/Data/GAPPS_Phthalate_WGCNA_QGComp_SigResults_071025.csv")
```

### Pull Component Effects
```{r}
CE <- ewas_qgcomp_fit.boot$component_effects
  
CE_Sig <- CE %>%
  dplyr::filter(probeID %in% sig_wgcna_qgcomp$probeID)

#Save Component EFfects
#write.csv(CE,"/Volumes/paquette_a/GAPPSGrant_PrelimData/Sam/Data/GAPPS_Phthalate_WGCNA_QGComp_ComponentEffects_071025.csv")

```



